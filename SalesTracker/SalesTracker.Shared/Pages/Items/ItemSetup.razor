@page "/items/setup"
@page "/items/setup/{id}"
@using Microsoft.AspNetCore.Components.Forms
@inject ItemService ItemService
@inject NavigationManager Navigation
@inject IImageCaptureService ImageCaptureService
@inject IImageStorageService ImageStorageService
@inject IImageProcessingService ImageProcessingService

<PageTitle>@(IsEditMode ? "Edit Item" : "New Item")</PageTitle>

<div class="container item-setup-container py-4">
    <div class="setup-header mb-4 pb-3">
        <h1 class="setup-title fw-bold mb-2">@(IsEditMode ? "Edit Item" : "Add New Item")</h1>
        <p class="text-muted mb-0">@(IsEditMode ? "Update the item information" : "Fill in the details to create a new item")</p>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2 flex-shrink-0">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0l-5.708 9.762a1.125 1.125 0 0 0 .95 1.679h11.432a1.125 1.125 0 0 0 .95-1.679L8.982 1.566ZM8 5a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 5Zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z"/>
            </svg>
            <span>@ErrorMessage</span>
            <button type="button" class="btn-close" @onclick="@(() => ErrorMessage = string.Empty)"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show d-flex align-items-center" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2 flex-shrink-0">
                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
            </svg>
            <span>@SuccessMessage</span>
            <button type="button" class="btn-close" @onclick="@(() => SuccessMessage = string.Empty)"></button>
        </div>
    }
    
    <form @onsubmit="HandleSubmit" class="setup-form">
        <!-- Basic Information Section -->
        <div class="form-section rounded p-4 mb-4 bg-secondary-subtle card">
            <div class="card-body">
                <h5 class="section-title pb-2 mb-3">Basic Information</h5>

                <div class="mb-3">
                    <label for="name" class="form-label">Item Name <span class="required">*</span></label>
                    <input type="text" class="form-control" id="name" @bind="CurrentItem.Name" placeholder="Enter item name" required />
                </div>

                <div class="mb-0">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" rows="3" @bind="CurrentItem.Description" placeholder="Add details about this item..."></textarea>
                </div>
            </div>
        </div>


        <!-- Images Section -->
        <div class="form-section rounded p-4 mb-4 bg-secondary-subtle card">
            <div class="card-body">
                <h5 class="section-title pb-2 mb-3">Images</h5>

                <div class="mb-3">
                    <label for="images" class="form-label">Upload Photos</label>
                    <div class="d-flex gap-2 flex-wrap">
                        <div class="file-input-wrapper flex-grow-1">
                            <InputFile id="images" onchange="HandleFileSelected" multiple accept="image/*" style="display: none" />
                            <label for="images" class="btn btn-primary upload-button-label">
                                <ImageIcon />
                                Choose Photos
                            </label>
                        </div>
                        @if (ImageCaptureService.SupportsCamera)
                        {
                            <button type="button" class="btn btn-outline-secondary" @onclick="HandleCameraCapture" title="Take a photo with camera">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z" />
                                    <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z" />
                                </svg>
                                Take Photo
                            </button>
                        }
                    </div>
                </div>
            </div>

            @if (SelectedFiles.Count > 0)
            {
                <div class="alert alert-info d-flex align-items-center mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2 flex-shrink-0">
                        <path d="M12.854.52a.5.5 0 0 0-.707 0L7.07 6.107 3.5 2.54a.5.5 0 1 0-.707.707L6.364 6.8 1.293 11.87a.5.5 0 1 0 .707.707L7.07 7.514l3.57 3.57a.5.5 0 1 0 .707-.707L7.777 6.807l5.076-5.076a.5.5 0 0 0 0-.707z" />
                    </svg>
                    <strong>@SelectedFiles.Count file(s) ready to upload</strong>
                </div>
            }
        </div>


        <!-- Pricing Section -->
        <div class="form-section rounded p-4 mb-4 bg-secondary-subtle card">
            <div class="card-body">
                <h5 class="section-title pb-2 mb-3">Pricing</h5>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="cost" class="form-label">Cost <span class="required">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="cost" step="0.01" @bind="CurrentItem.Cost" placeholder="0.00" required />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="salePrice" class="form-label">Sale Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="salePrice" step="0.01" @bind="CurrentItem.SalePrice" placeholder="0.00" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div class="form-section rounded p-4 mb-4 bg-secondary-subtle card">
            <div class="card-body">
                <h5 class="section-title pb-2 mb-3">Inventory</h5>

                <div class="mb-0">
                    <label for="inventory" class="form-label">@(IsEditMode ? "Current Quantity" : "Initial Quantity")</label>
                    <input type="number" class="form-control" id="inventory" @bind="CurrentItem.CurrentInventoryQty" placeholder="0" />
                    <small class="form-text text-muted">Number of units in stock</small>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 flex-wrap pt-3 border-top">
            <a href="/items/view" class="btn btn-outline-secondary btn-lg flex-grow-1">Cancel</a>
            <button type="submit" class="btn btn-primary btn-lg flex-grow-1" disabled="@IsSubmitting">
                @if (IsSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>@(IsEditMode ? "Save Changes" : "Create Item")</span>
                }
            </button>
        </div>
    </form>
</div>

@code {
[Parameter]
public string? Id { get; set; }

private Item CurrentItem = new();
private bool IsEditMode = false;
private bool IsSubmitting = false;
private string ErrorMessage = string.Empty;
private string SuccessMessage = string.Empty;
private List<ItemImage> SelectedFiles = new();

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Id) && int.TryParse(Id, out var itemId))
        {
            IsEditMode = true;
            var item = await ItemService.GetItemByIdAsync(itemId);
            if (item != null)
            {
                CurrentItem = item;
            }
            else
            {
                ErrorMessage = "Item not found.";
            }
        }
    }

    private async Task HandleCameraCapture()
    {
        try
        {
            System.Diagnostics.Debug.WriteLine("HandleCameraCapture called");
            var photoPath = await ImageCaptureService.CapturePhotoAsync();
            
            System.Diagnostics.Debug.WriteLine($"Photo path returned: {photoPath}");
            
            if (string.IsNullOrEmpty(photoPath))
            {
                ErrorMessage = "Camera capture cancelled or failed. Check if camera permissions are granted.";
                StateHasChanged();
                return;
            }

            // Get file info
            var fileInfo = new FileInfo(photoPath);
            System.Diagnostics.Debug.WriteLine($"File exists: {fileInfo.Exists}, Size: {fileInfo.Length}");
            
            if (fileInfo.Length > 5242880) // 5 MB limit
            {
                ErrorMessage = "Photo file is too large. Maximum size is 5 MB.";
                StateHasChanged();
                return;
            }

            // Process the image
            System.Diagnostics.Debug.WriteLine("Processing image...");
            using var stream = File.OpenRead(photoPath);
            var imagePath = await ImageProcessingService.ProcessImageToBase64Async(stream, fileInfo.Name, 400, 400);
            
            System.Diagnostics.Debug.WriteLine($"Image processed, path/URI length: {imagePath.Length}");
            
            // Store the actual file path from the camera capture
            SelectedFiles.Add(new ItemImage
            {
                ImagePath = imagePath,
                IsPrimary = SelectedFiles.Count == 0, // First image is primary
                DisplayOrder = SelectedFiles.Count
            });

            System.Diagnostics.Debug.WriteLine("Image added to selected files");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error in HandleCameraCapture: {ex}");
            ErrorMessage = $"Error capturing photo: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        SelectedFiles.Clear();
        
        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > 5242880) // 5 MB limit
            {
                ErrorMessage = $"File {file.Name} is too large. Maximum size is 5 MB.";
                continue;
            }

            try
            {
                // Process the image (resize and convert to base64/path)
                using var stream = file.OpenReadStream(5242880);
                var imagePath = await ImageProcessingService.ProcessImageToBase64Async(stream, file.Name, 400, 400);
                
                // Add to selected files list
                SelectedFiles.Add(new ItemImage
                {
                    ImagePath = imagePath,
                    IsPrimary = SelectedFiles.Count == 0, // First image is primary
                    DisplayOrder = SelectedFiles.Count
                });
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error processing file: {ex.Message}";
            }
        }

        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        IsSubmitting = true;

        try
        {
            // Add selected images to the item
            foreach (var selectedFile in SelectedFiles)
            {
                // Only add if it's a new image (no ImageID means it's new)
                if (selectedFile.ImageID == 0)
                {
                    CurrentItem.Images.Add(selectedFile);
                }
            }

            if (IsEditMode)
            {
                await ItemService.UpdateItemAsync(CurrentItem);
                SuccessMessage = "Item updated successfully!";
            }
            else
            {
                var newId = await ItemService.CreateItemAsync(CurrentItem);
                SuccessMessage = "Item created successfully!";
                CurrentItem.ItemID = newId;
            }

            // Redirect after 1 second
            await Task.Delay(300);
            Navigation.NavigateTo($"/items/detail/{CurrentItem.ItemID}");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}
