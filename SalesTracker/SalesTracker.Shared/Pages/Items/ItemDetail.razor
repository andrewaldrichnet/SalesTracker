@page "/items/detail/{ItemId:int}"
@using SalesTracker.Shared.Components
@using SalesTracker.Shared.Models
@inject ItemService ItemService
@inject OrderService OrderService
@inject IImageStorageService ImageStorageService
@inject NavigationManager Navigation

<PageTitle>Item Details</PageTitle>

<div class="item-detail-container">
    @if (IsLoading)
    {
        <p>Loading item details...</p>
    }
    else if (Item == null)
    {
        <div class="alert alert-warning" role="alert">
            Item not found. <a href="/items/view">Back to items</a>
        </div>
    }
    else
    {
        <div class="item-detail-header">
            <div class="header-nav">
                <a href="/items/view" class="btn btn-outline-secondary">? Back to Items</a>
            </div>
            <div class="header-actions">
                <a href="/items/setup/@Item.ItemID" class="btn btn-warning">Edit</a>
                <button class="btn btn-danger" @onclick="HandleDelete">Delete</button>
            </div>
        </div>

        <div class="item-detail-content">
            <div class="item-detail-main">
                <div class="item-images-section">
                    @if (Item.Images?.Count > 0)
                    {
                        <div class="main-image">
                            @{
                                var mainImage = Item.Images.FirstOrDefault(i => i.IsPrimary) ?? Item.Images[0];
                                var imageUri = ImageStorageService.GetImageUri(mainImage.ImagePath);
                            }
                            @if (!string.IsNullOrEmpty(imageUri))
                            {
                                <img src="@imageUri" alt="@Item.Name" class="img-fluid" />
                            }
                        </div>

                        @if (Item.Images.Count > 1)
                        {
                            <div class="thumbnail-images">
                                @foreach (var image in Item.Images)
                                {
                                    var thumbUri = ImageStorageService.GetImageUri(image.ImagePath);
                                    <div class="thumbnail @(image.ImageID == SelectedImageId ? "active" : "")" 
                                         @onclick="() => SelectImage(image.ImageID)"
                                         style="cursor: pointer;">
                                        @if (!string.IsNullOrEmpty(thumbUri))
                                        {
                                            <img src="@thumbUri" alt="Thumbnail" />
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="no-image-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14.5 1a1.5 1.5 0 0 1 1.5 1.5v12a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-12A1.5 1.5 0 0 1 1.5 1h13zm-13-1A2.5 2.5 0 0 0-1 2.5v12A2.5 2.5 0 0 0 1.5 17h13a2.5 2.5 0 0 0 2.5-2.5v-12A2.5 2.5 0 0 0 14.5 0h-13z"/>
                                <path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 1 1-.708-.708L9.172 8 7.146 6.146a.5.5 0 1 1 .708-.708l3 3z"/>
                            </svg>
                            <p>No images available</p>
                        </div>
                    }
                </div>

                <div class="item-info-section">
                    <h1>@Item.Name</h1>
                    @if (!string.IsNullOrEmpty(Item.Description))
                    {
                        <p class="item-description">@Item.Description</p>
                    }

                    <div class="item-pricing">
                        <div class="price-info">
                            <label>Sale Price:</label>
                            <span class="price-value">@(Item.SalePrice.HasValue ? $"${Item.SalePrice.Value:F2}" : "N/A")</span>
                        </div>
                        <div class="cost-info">
                            <label>Cost:</label>
                            <span>$@Item.Cost.ToString("F2")</span>
                        </div>
                    </div>

                    <div class="item-inventory">
                        <h3>Inventory</h3>
                        <div class="inventory-stats">
                            <div class="stat">
                                <label>Current Inventory:</label>
                                <span class="stat-value">@Item.CurrentInventoryQty</span>
                            </div>
                            <div class="stat">
                                <label>Allocated (Pending):</label>
                                <span class="stat-value text-warning">@Item.AllocatedInventoryQty</span>
                            </div>
                            <div class="stat">
                                <label>Available:</label>
                                <span class="stat-value @(Item.AvailableInventoryQty < 0 ? "text-danger" : "")">@Item.AvailableInventoryQty</span>
                            </div>
                        </div>

                        <div class="inventory-adjustment">
                            <h4>Adjust Inventory</h4>
                            <div class="adjustment-form">
                                <div class="form-group">
                                    <label for="adjustmentAmount">Amount:</label>
                                    <input type="number" id="adjustmentAmount" class="form-control" @bind="AdjustmentAmount" />
                                </div>
                                <div class="form-group">
                                    <label for="adjustmentReason">Reason:</label>
                                    <select id="adjustmentReason" class="form-control" @bind="AdjustmentReason">
                                        <option value="">-- Select Reason --</option>
                                        <option value="restock">Restock</option>
                                        <option value="damaged">Damaged/Loss</option>
                                        <option value="correction">Inventory Correction</option>
                                        <option value="return">Customer Return</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" @onclick="ApplyInventoryAdjustment">Apply Adjustment</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="item-detail-sidebar">
                <div class="detail-card">
                    <h3>Past Orders</h3>
                    @if (IsLoadingOrders)
                    {
                        <p>Loading orders...</p>
                    }
                    else if (RelatedOrders.Count == 0)
                    {
                        <p class="text-muted">No orders for this item yet.</p>
                    }
                    else
                    {
                        <div class="orders-list">
                            @foreach (var order in RelatedOrders)
                            {
                                <div class="order-card" @onclick="() => NavigateToOrderDetail(order.OrderID)" style="cursor: pointer;">
                                    <div class="order-card-header">
                                        <strong>@order.CustomerName</strong>
                                        <small class="text-muted">@order.SellDate.ToString("MMM dd, yyyy")</small>
                                    </div>
                                    <div class="order-card-body">
                                        <div>Qty: <span class="badge bg-info">@order.Qty</span></div>
                                        <div>Price: <span class="price">@order.Price.ToString("C2")</span></div>
                                        <div class="order-status">
                                            @if (order.HasDelivered)
                                            {
                                                <span class="badge bg-success">Delivered</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Pending</span>
                                            }
                                            @if (order.HasReceivedPayment)
                                            {
                                                <span class="badge bg-success">Paid</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Unpaid</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="detail-card">
                    <h3>Item Info</h3>
                    <dl class="row">
                        <dt class="col-sm-6">ID:</dt>
                        <dd class="col-sm-6">@Item.ItemID</dd>
                        <dt class="col-sm-6">Created:</dt>
                        <dd class="col-sm-6">@Item.CreatedDate.ToString("MMM dd, yyyy")</dd>
                        <dt class="col-sm-6">Modified:</dt>
                        <dd class="col-sm-6">@Item.ModifiedDate.ToString("MMM dd, yyyy")</dd>
                    </dl>
                </div>
            </div>
        </div>
    }
</div>

<ConfirmationDialog @ref="ConfirmDialog" 
    Title="Delete Item" 
    Message="Are you sure you want to delete this item? This action cannot be undone." 
    ConfirmText="Delete" 
    CancelText="Cancel" />

@code {
    [Parameter]
    public int ItemId { get; set; }

    private Item? Item;
    private List<Order> RelatedOrders = new();
    private bool IsLoading = true;
    private bool IsLoadingOrders = true;
    private string ErrorMessage = string.Empty;
    private ConfirmationDialog? ConfirmDialog;
    private int SelectedImageId = 0;

    // Inventory adjustment properties
    private int AdjustmentAmount = 0;
    private string AdjustmentReason = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadItem();
        await LoadRelatedOrders();
    }

    private async Task LoadItem()
    {
        try
        {
            IsLoading = true;
            Item = await ItemService.GetItemByIdAsync(ItemId);
            if (Item?.Images?.Count > 0)
            {
                SelectedImageId = Item.Images.First().ImageID;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading item: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadRelatedOrders()
    {
        try
        {
            IsLoadingOrders = true;
            var allOrders = await OrderService.GetAllOrdersAsync();
            RelatedOrders = allOrders
                .Where(o => o.ItemID == ItemId)
                .OrderByDescending(o => o.SellDate)
                .ToList();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading orders: {ex.Message}";
        }
        finally
        {
            IsLoadingOrders = false;
        }
    }

    private void SelectImage(int imageId)
    {
        SelectedImageId = imageId;
    }

    private async Task ApplyInventoryAdjustment()
    {
        if (Item == null)
            return;

        if (string.IsNullOrWhiteSpace(AdjustmentReason))
        {
            ErrorMessage = "Please select a reason for the adjustment.";
            return;
        }

        try
        {
            Item.CurrentInventoryQty += AdjustmentAmount;
            Item.CurrentInventoryQty = Math.Max(0, Item.CurrentInventoryQty);
            await ItemService.UpdateItemAsync(Item);

            AdjustmentAmount = 0;
            AdjustmentReason = string.Empty;
            ErrorMessage = "Inventory adjusted successfully.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error updating inventory: {ex.Message}";
        }
    }

    private void NavigateToOrderDetail(int orderId)
    {
        Navigation.NavigateTo($"/sales/detail/{orderId}");
    }

    private async Task HandleDelete()
    {
        if (ConfirmDialog == null || !await ConfirmDialog.ShowAsync())
            return;

        try
        {
            await ItemService.DeleteItemAsync(ItemId);
            Navigation.NavigateTo("/items/view");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error deleting item: {ex.Message}";
        }
    }
}
