@page "/sales/detail/{OrderId:int}"
@using SalesTracker.Shared.Components
@using SalesTracker.Shared.Models
@inject OrderService OrderService
@inject ItemService ItemService
@inject IImageStorageService ImageStorageService
@inject NavigationManager Navigation

<PageTitle>Order Details</PageTitle>

<div class="order-detail-container">
    @if (IsLoading)
    {
        <p>Loading order details...</p>
    }
    else if (Order == null)
    {
        <div class="alert alert-warning" role="alert">
            Order not found. <a href="/sales/view">Back to sales</a>
        </div>
    }
    else
    {
        <div class="order-detail-header">
            <div class="header-nav">
                <a href="/sales/view" class="btn btn-outline-secondary">? Back to Sales</a>
            </div>
            <div class="header-actions">
                <a href="/sales/setup/@Order.OrderID" class="btn btn-warning">Edit</a>
                <button class="btn btn-danger" @onclick="HandleDelete">Delete</button>
            </div>
        </div>

        <div class="order-detail-content">
            <div class="order-detail-main">
                <div class="order-status-section">
                    <h2>Order #@Order.OrderID</h2>
                    <div class="status-badges">
                        @if (Order.HasDelivered)
                        {
                            <span class="badge bg-success">Delivered @(Order.DeliveryDate.HasValue ? $"on {Order.DeliveryDate:MMM dd, yyyy}" : "")</span>
                        }
                        else
                        {
                            <span class="badge bg-warning">Pending Delivery</span>
                            <button class="btn btn-sm btn-success" @onclick="MarkAsDelivered">Mark as Delivered</button>
                        }

                        @if (Order.HasReceivedPayment)
                        {
                            <span class="badge bg-success">Paid @(Order.PaymentDate.HasValue ? $"on {Order.PaymentDate:MMM dd, yyyy}" : "")</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Unpaid</span>
                            <button class="btn btn-sm btn-success" @onclick="MarkAsPaid">Mark as Paid</button>
                        }
                    </div>
                </div>

                <div class="order-customer-section">
                    <h3>Customer Information</h3>
                    <div class="customer-info">
                        <strong>@Order.CustomerName</strong>
                    </div>
                </div>

                <div class="order-item-section">
                    <h3>Item Details</h3>
                    @if (Item != null)
                    {
                        <div class="item-details-card">
                            <div class="item-details-image">
                                @if (Item.Images?.Count > 0 && !string.IsNullOrEmpty(Item.Images[0].ImagePath))
                                {
                                    <div class="image-carousel">
                                        @{
                                            var currentImage = Item.Images.FirstOrDefault(i => i.ImageID == SelectedImageId) ?? Item.Images[0];
                                            var imageUri = ImageStorageService.GetImageUri(currentImage.ImagePath);
                                        }
                                        @if (!string.IsNullOrEmpty(imageUri))
                                        {
                                            <img src="@imageUri" alt="@Item.Name" class="img-fluid" />
                                        }

                                        @if (Item.Images.Count > 1)
                                        {
                                            <div class="image-thumbnails">
                                                @foreach (var image in Item.Images)
                                                {
                                                    var thumbUri = ImageStorageService.GetImageUri(image.ImagePath);
                                                    <div class="thumbnail @(image.ImageID == SelectedImageId ? "active" : "")" 
                                                         @onclick="() => SelectImage(image.ImageID)"
                                                         style="cursor: pointer;">
                                                        @if (!string.IsNullOrEmpty(thumbUri))
                                                        {
                                                            <img src="@thumbUri" alt="Thumbnail" />
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="no-image-placeholder">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M14.5 1a1.5 1.5 0 0 1 1.5 1.5v12a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-12A1.5 1.5 0 0 1 1.5 1h13zm-13-1A2.5 2.5 0 0 0-1 2.5v12A2.5 2.5 0 0 0 1.5 17h13a2.5 2.5 0 0 0 2.5-2.5v-12A2.5 2.5 0 0 0 14.5 0h-13z"/>
                                            <path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 1 1-.708-.708L9.172 8 7.146 6.146a.5.5 0 1 1 .708-.708l3 3z"/>
                                        </svg>
                                    </div>
                                }
                            </div>

                            <div class="item-details-info">
                                <h4>@Item.Name</h4>
                                @if (!string.IsNullOrEmpty(Item.Description))
                                {
                                    <p class="item-description">@Item.Description</p>
                                }

                                <div class="item-pricing-details">
                                    <div class="pricing-row">
                                        <strong>Sale Price:</strong>
                                        <span>@(Item.SalePrice?.ToString("C2") ?? "N/A")</span>
                                    </div>
                                    <div class="pricing-row">
                                        <strong>Cost:</strong>
                                        <span>@Item.Cost.ToString("C2")</span>
                                    </div>
                                </div>

                                <a href="/items/detail/@Item.ItemID" class="btn btn-outline-primary btn-sm">View Item Details</a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">Item not found</div>
                    }
                </div>

                <div class="order-details-section">
                    <h3>Order Summary</h3>
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Quantity:</span>
                            <strong>@Order.Qty @(Order.Qty == 1 ? "unit" : "units")</strong>
                        </div>
                        <div class="summary-row">
                            <span>Order Date:</span>
                            <strong>@Order.SellDate.ToString("MMM dd, yyyy")</strong>
                        </div>
                        <div class="summary-row">
                            <span>Unit Price:</span>
                            <strong>@Order.Price.ToString("C2")</strong>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <strong>@((Order.Price * Order.Qty).ToString("C2"))</strong>
                        </div>
                        @{
                            var profit = (Order.Price - Item?.Cost ?? 0) * Order.Qty;
                        }
                        <div class="summary-row @(profit >= 0 ? "profit" : "loss")">
                            <span>Profit:</span>
                            <strong>@profit.ToString("C2")</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="order-detail-sidebar">
                <div class="detail-card">
                    <h3>Timeline</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker">??</div>
                            <div class="timeline-content">
                                <strong>Order Created</strong>
                                <small>@Order.CreatedDate.ToString("MMM dd, yyyy HH:mm")</small>
                            </div>
                        </div>

                        @if (Order.HasReceivedPayment && Order.PaymentDate.HasValue)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker">??</div>
                                <div class="timeline-content">
                                    <strong>Payment Received</strong>
                                    <small>@Order.PaymentDate.Value.ToString("MMM dd, yyyy HH:mm")</small>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="timeline-item pending">
                                <div class="timeline-marker">??</div>
                                <div class="timeline-content">
                                    <strong>Awaiting Payment</strong>
                                </div>
                            </div>
                        }

                        @if (Order.HasDelivered && Order.DeliveryDate.HasValue)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker">??</div>
                                <div class="timeline-content">
                                    <strong>Delivered</strong>
                                    <small>@Order.DeliveryDate.Value.ToString("MMM dd, yyyy HH:mm")</small>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="timeline-item pending">
                                <div class="timeline-marker">??</div>
                                <div class="timeline-content">
                                    <strong>Awaiting Delivery</strong>
                                </div>
                            </div>
                        }

                        <div class="timeline-item">
                            <div class="timeline-marker">??</div>
                            <div class="timeline-content">
                                <strong>Last Modified</strong>
                                <small>@Order.ModifiedDate.ToString("MMM dd, yyyy HH:mm")</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3>Order Info</h3>
                    <dl class="row">
                        <dt class="col-sm-6">Order ID:</dt>
                        <dd class="col-sm-6">@Order.OrderID</dd>
                        <dt class="col-sm-6">Item ID:</dt>
                        <dd class="col-sm-6">@Order.ItemID</dd>
                        <dt class="col-sm-6">Payment Status:</dt>
                        <dd class="col-sm-6">@(Order.HasReceivedPayment ? "Paid" : "Unpaid")</dd>
                        <dt class="col-sm-6">Delivery Status:</dt>
                        <dd class="col-sm-6">@(Order.HasDelivered ? "Delivered" : "Pending")</dd>
                    </dl>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @ErrorMessage
                <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
            </div>
        }
    }
</div>

<ConfirmationDialog @ref="ConfirmDialog" 
    Title="Delete Order" 
    Message="Are you sure you want to delete this order? This action cannot be undone and will deallocate inventory." 
    ConfirmText="Delete" 
    CancelText="Cancel" />

@code {
    [Parameter]
    public int OrderId { get; set; }

    private Order? Order;
    private Item? Item;
    private bool IsLoading = true;
    private string ErrorMessage = string.Empty;
    private ConfirmationDialog? ConfirmDialog;
    private int SelectedImageId = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
    }

    private async Task LoadOrder()
    {
        try
        {
            IsLoading = true;
            Order = await OrderService.GetOrderByIdAsync(OrderId);
            
            if (Order != null)
            {
                Item = await ItemService.GetItemByIdAsync(Order.ItemID);
                if (Item?.Images?.Count > 0)
                {
                    SelectedImageId = Item.Images.First().ImageID;
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading order: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void SelectImage(int imageId)
    {
        SelectedImageId = imageId;
    }

    private async Task MarkAsDelivered()
    {
        if (Order == null)
            return;

        try
        {
            await OrderService.MarkAsDeliveredAsync(Order.OrderID);
            Order = await OrderService.GetOrderByIdAsync(Order.OrderID);
            ErrorMessage = "Order marked as delivered.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error marking order as delivered: {ex.Message}";
        }
    }

    private async Task MarkAsPaid()
    {
        if (Order == null)
            return;

        try
        {
            await OrderService.MarkAsPaidAsync(Order.OrderID);
            Order = await OrderService.GetOrderByIdAsync(Order.OrderID);
            ErrorMessage = "Order marked as paid.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error marking order as paid: {ex.Message}";
        }
    }

    private async Task HandleDelete()
    {
        if (ConfirmDialog == null || !await ConfirmDialog.ShowAsync())
            return;

        try
        {
            await OrderService.DeleteOrderAsync(OrderId);
            Navigation.NavigateTo("/sales/view");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error deleting order: {ex.Message}";
        }
    }
}
