@page "/sales/view"
@inject OrderService OrderService
@inject ItemService ItemService
@inject NavigationManager Navigation

<PageTitle>Sales</PageTitle>

<div class="view-sales-container">
    <div class="sales-header">
        <h2>Sales</h2>
        <a href="/sales/setup" class="btn btn-primary btn-lg">New Sale</a>
    </div>

    @if (IsLoading)
    {
        <p>Loading sales...</p>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @ErrorMessage
        </div>
    }
    else if (Orders.Count == 0)
    {
        <p>No sales found. <a href="/sales/setup">Create one now.</a></p>
    }
    else
    {
        <div class="search-section">
            <div class="search-box">
                <InputText class="search-input" placeholder="Search by customer name..." @bind-Value="SearchTerm" @onchange="HandleSearch" />
                <button class="btn btn-primary search-btn" @onclick="HandleSearch" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.397h-.001c.003-.003.006-.006.009-.009l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.009-.009zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="filter-tabs">
            <button class="filter-pill @(CurrentFilter == FilterType.All ? "active" : "")" 
                    @onclick="() => SetFilter(FilterType.All)">
                All Sales
            </button>
            <button class="filter-pill @(CurrentFilter == FilterType.PendingDelivery ? "active" : "")" 
                    @onclick="() => SetFilter(FilterType.PendingDelivery)">
                Pending Delivery
            </button>
            <button class="filter-pill @(CurrentFilter == FilterType.Unpaid ? "active" : "")" 
                    @onclick="() => SetFilter(FilterType.Unpaid)">
                Unpaid
            </button>
        </div>

        <div class="orders-list">
            @foreach (var order in FilteredOrders)
            {
                var item = Items.FirstOrDefault(i => i.ItemID == order.ItemID);
                <OrderRow Order="order" Item="item" OnClick="HandleOrderClick" />
            }
        </div>
    }
</div>

<ConfirmationDialog @ref="ConfirmDialog" Title="Delete Order" Message="Are you sure you want to delete this order? This action cannot be undone." ConfirmText="Delete" CancelText="Cancel" />

@code {
    private enum FilterType
    {
        All,
        PendingDelivery,
        Unpaid
    }

    private List<Order> Orders = new();
    private List<Order> AllOrders = new();
    private List<Item> Items = new();
    private bool IsLoading = true;
    private string ErrorMessage = string.Empty;
    private string SearchTerm = string.Empty;
    private ConfirmationDialog? ConfirmDialog;
    private FilterType CurrentFilter = FilterType.All;

    private List<Order> FilteredOrders
    {
        get
        {
            var orders = Orders;

            return CurrentFilter switch
            {
                FilterType.PendingDelivery => orders.Where(o => !o.HasDelivered).ToList(),
                FilterType.Unpaid => orders.Where(o => !o.HasReceivedPayment).ToList(),
                _ => orders
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = string.Empty;
            AllOrders = await OrderService.GetAllOrdersAsync();
            Orders = AllOrders.OrderByDescending(o => o.SellDate).ToList();
            
            // Load items
            Items = await ItemService.GetAllItemsAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading orders: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            Orders = AllOrders.OrderByDescending(o => o.SellDate).ToList();
        }
        else
        {
            Orders = await OrderService.SearchByCustomerAsync(SearchTerm);
            Orders = Orders.OrderByDescending(o => o.SellDate).ToList();
        }
    }

    private void SetFilter(FilterType filter)
    {
        CurrentFilter = filter;
    }

    private void HandleOrderClick(Order order)
    {
        Navigation.NavigateTo($"/sales/setup/{order.OrderID}");
    }

    private async Task HandleDelete(int orderId)
    {
        if (ConfirmDialog == null || !await ConfirmDialog.ShowAsync())
            return;

        try
        {
            await OrderService.DeleteOrderAsync(orderId);
            await LoadOrders();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error deleting order: {ex.Message}";
        }
    }
}

