@page "/sales/view"
@inject OrderService OrderService
@inject ItemService ItemService
@inject NavigationManager Navigation

<PageTitle>Sales</PageTitle>
<div class="main-content">
    <div class="view-sales-container">
        <div class="sales-header d-md-flex justify-content-between mb-3 align-items-end">
            <h2 class="fw-bolder m-0 mb-3 mb-lg-0">Sales</h2>
            <a href="/sales/setup" class="btn btn-primary btn-lg">
                <PlusIcon CssClass="me-1" />New Sale
            </a>
        </div>

        <div class="search-section">
            <div class="search-box d-flex gap-3">
                <InputText class="search-input form-control" placeholder="Search by customer name..." ValueExpression="@(() => SearchTerm)" @oninput="OnInputAsync" @onkeydown="OnKeydownAsync" />
                <button class="btn btn-primary search-btn" @onclick="HandleSearch" title="Search">
                    <SearchIcon />
                </button>
            </div>
        </div>

        <div class="filter-tabs mt-3">
            <button class="filter-pill text-body @(CurrentFilter == FilterType.All ? "active" : "")"
                    @onclick="() => SetFilter(FilterType.All)">
                All Sales
            </button>
            <button class="filter-pill text-body @(CurrentFilter == FilterType.PendingDelivery ? "active" : "")"
                    @onclick="() => SetFilter(FilterType.PendingDelivery)">
                Pending Delivery
            </button>
            <button class="filter-pill text-body @(CurrentFilter == FilterType.Unpaid ? "active" : "")"
                    @onclick="() => SetFilter(FilterType.Unpaid)">
                Unpaid
            </button>
        </div>


        @if (IsLoading)
        {
        <p>Loading sales...</p>
        }
        else if (!string.IsNullOrEmpty(ErrorMessage))
        {
        <div class="alert alert-danger" role="alert">
            @ErrorMessage
        </div>
        }
        else if (Orders.Count == 0)
        {
        <p>No sales found. <a href="/sales/setup">Create one now.</a></p>
        }
        else
        {
        <div class="orders-list">
            @foreach (var order in FilteredOrders)
            {
            var item = Items.FirstOrDefault(i => i.ItemID == order.ItemID);
            <OrderRow Order="order" Item="item" OnClick="HandleOrderClick" />
            }
        </div>
        }
    </div>
</div>
<ConfirmationDialog @ref="ConfirmDialog" Title="Delete Order" Message="Are you sure you want to delete this order? This action cannot be undone." ConfirmText="Delete" CancelText="Cancel" />

@code {
    private enum FilterType
    {
        All,
        PendingDelivery,
        Unpaid
    }

    private List<Order> Orders = new();
    private List<Order> AllOrders = new();
    private List<Item> Items = new();
    private bool IsLoading = true;
    private string ErrorMessage = string.Empty;
    private string SearchTerm = string.Empty;
    private ConfirmationDialog? ConfirmDialog;
    private FilterType CurrentFilter = FilterType.All;

    private List<Order> FilteredOrders
    {
        get
        {
            var orders = Orders;

            return CurrentFilter switch
            {
                FilterType.PendingDelivery => orders.Where(o => !o.HasDelivered).ToList(),
                FilterType.Unpaid => orders.Where(o => !o.HasReceivedPayment).ToList(),
                _ => orders
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = string.Empty;
            AllOrders = await OrderService.GetAllOrdersAsync();
            Orders = AllOrders.OrderByDescending(o => o.SellDate).ToList();

            // Load items
            Items = await ItemService.GetAllItemsAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading orders: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            Orders = AllOrders.OrderByDescending(o => o.SellDate).ToList();
        }
        else
        {
            Orders = await OrderService.SearchByCustomerAsync(SearchTerm);
            Orders = Orders.OrderByDescending(o => o.SellDate).ToList();
        }
    }

    private async Task OnInputAsync(ChangeEventArgs e)
    {
        SearchTerm = e.Value?.ToString() ?? string.Empty;
        //await HandleSearch();
        if (string.IsNullOrEmpty(SearchTerm))
        {
            await HandleSearch();
        }
    }

    private async Task OnKeydownAsync(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleSearch();
        }
    }

    private void SetFilter(FilterType filter)
    {
        CurrentFilter = filter;
    }

    private void HandleOrderClick(Order order)
    {
        Navigation.NavigateTo($"/sales/detail/{order.OrderID}");
    }

    private async Task HandleDelete(int orderId)
    {
        if (ConfirmDialog == null || !await ConfirmDialog.ShowAsync())
            return;

        try
        {
            await OrderService.DeleteOrderAsync(orderId);
            await LoadOrders();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error deleting order: {ex.Message}";
        }
    }
}

