@using SalesTracker.Shared.Models
@inject IImageStorageService ImageStorageService

<div class="order-row" @onclick="HandleClick" style="cursor: pointer;">
    <div class="order-row-image">
        <ItemImageDisplay Image="Item?.Images?.FirstOrDefault()" AltText="Item.Name" />
    </div>

    <div class="order-row-middle">
        <div class="order-row-header">
            <h5 class="order-customer">@Order.CustomerName</h5>
            @if (!string.IsNullOrEmpty(StatusBadgeText))
            {
                <span class="@StatusBadgeClass">@StatusBadgeText</span>
            }
        </div>

        <div class="order-row-meta">
            <span class="order-date">@Order.SellDate.ToString("MMM dd, yyyy")</span>
            <span class="order-separator">•</span>
            <span class="order-item">@(Item?.Name ?? "Unknown Item")</span>
        </div>
    </div>

    <div class="order-row-pricing-inventory">
        <div class="price-stack">
            <div class="order-price">
                <span>$@Order.Price.ToString("F2")</span>
            </div>
            <InventoryStatus 
                IsSold="Order.HasDelivered" 
                SoldQty="Order.HasDelivered ? Order.Qty : null"
                AllocatedQty="Order.HasDelivered ? null : Item?.AllocatedInventoryQty"
                CurrentQty="Order.HasDelivered ? null : Item?.CurrentInventoryQty"
                AvailableQty="Order.HasDelivered ? null : Item?.AvailableInventoryQty" />
        </div>
    </div>

    <div class="order-row-arrow">
        <ArrowRightShortIcon />
    </div>
</div>

@code {
    [Parameter]
    public required Order Order { get; set; }

    [Parameter]
    public Item? Item { get; set; }

    [Parameter]
    public EventCallback<Order> OnClick { get; set; }

    private string StatusBadgeText => GetStatusBadgeText();
    private string StatusBadgeClass => GetStatusBadgeClass();

    private string GetStatusBadgeText()
    {
        // If delivered and paid, no badge
        if (Order.HasDelivered && Order.HasReceivedPayment)
            return string.Empty;

        // If unpaid (regardless of delivery status)
        if (!Order.HasReceivedPayment)
            return "Unpaid";

        // If pending delivery but paid
        if (!Order.HasDelivered)
            return "Pending";

        return string.Empty;
    }

    private string GetStatusBadgeClass()
    {
        return StatusBadgeText switch
        {
            "Unpaid" => "badge bg-warning",
            "Pending" => "badge bg-info",
            _ => ""
        };
    }

    private async Task HandleClick()
    {
        await OnClick.InvokeAsync(Order);
    }
}
